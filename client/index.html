<html>
<head>
<title>Index Page!</title>
<script>
var tileSize = 64;

function makeStringImage(s) {
    var canvas = document.createElement("canvas");
    canvas.width = canvas.height = tileSize;
    var ctx = canvas.getContext("2d");
    var metrics = ctx.measureText(s);
    var sx = canvas.width/metrics.width;
    var sy = canvas.height/metrics.width;
    ctx.scale(sx, sy);
    ctx.fillText(s, 0, canvas.height/sy);
    return canvas;
}

function makeChessImages() {
    function aux(obj, base) {
        obj.King   = makeStringImage(String.fromCharCode(base+0));
        obj.Queen  = makeStringImage(String.fromCharCode(base+1));
        obj.Rook   = makeStringImage(String.fromCharCode(base+2));
        obj.Bishop = makeStringImage(String.fromCharCode(base+3));
        obj.Knight = makeStringImage(String.fromCharCode(base+4));
        obj.Pawn   = makeStringImage(String.fromCharCode(base+5));
    }
    var chessImages = {};
    chessImages.White = {};
    aux(chessImages.White, 0x2654);
    chessImages.Black = {};
    aux(chessImages.Black, 0x265A);
    return chessImages;
}

function displayBoard(gameState) {
    var canvas = document.getElementById("chessBoardCanvas");
    canvas.width = canvas.height = 8*tileSize;
    var ctx = canvas.getContext("2d");
    var tiles = makeChessImages();
    gameState.gsBoard.forEach(function(e) {
        var x = e[0][0]-1;
        var y = e[0][1]-1;
        if((x+y)%2 == 0) {
            ctx.fillStyle = "#c0c0c0";
            ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
        }
        var piece = e[1];
        if(piece) { ctx.drawImage(tiles[piece.cpColor][piece.cpType], x*tileSize, y*tileSize); }
    });
}

function askForValidMoves(sock, canvas) {
    return function(event) {
        var rect = canvas.getBoundingClientRect();
        var ix = ((event.clientX - rect.x) / tileSize)|0;
        var iy = ((event.clientY - rect.y) / tileSize)|0;
        var msg = {};
        msg.tag = "RequestValidMoves";
        msg.contents = [ix+1, iy+1];
        sock.send(JSON.stringify(msg));
    };
}

function overlayValidMoves(validMoves) {
    var canvas = document.getElementById("chessBoardCanvas");
    var ctx = canvas.getContext("2d");
    var oldGlobalAlpha = ctx.globalAlpha;
    ctx.globalAlpha = 0.4;
    ctx.fillStyle = "#0000c0";
    validMoves[1].forEach(function(e) {
        console.log(JSON.stringify(e));
        var x = e[0][0]-1;
        var y = e[0][1]-1;
        var valid = e[1];
        if(valid) { ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize); }
    });
    ctx.globalAlpha = oldGlobalAlpha;
}

function main() {
    var content = document.getElementById("content");
    content.textContent += "<script>alert('xss');<\/script>\n";
    var sock = new WebSocket(document.URL.replace("http", "ws"));
    var handlers = {};
    handlers["DisplayGameState"] = displayBoard;
    handlers["RespondValidMoves"] = overlayValidMoves;
    sock.onmessage = function(event) {
        content.textContent += event.data + "\n";
        var obj = JSON.parse(event.data);
        handlers[obj.tag](obj.contents);
    };
    var canvas = document.getElementById("chessBoardCanvas");
    canvas.onclick = askForValidMoves(sock, canvas);
}
</script>
</head>
<body onload="main();">
<pre id="content"></pre>
<canvas id="chessBoardCanvas" />
</body>
</html>
